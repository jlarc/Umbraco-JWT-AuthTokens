<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Umbraco-jwt-authtokens by oromand</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>THEMEFORCES FREEBIE #1</title>
    <meta name="description" content="FREE - FLAT MINIMAL UI KIT">
    <meta name="keywords" content="freebies, free html UI KIT, flat UI kit, free UI kit, minimal UI, Responsive, bootstrap, themeforce">
    <meta name="author" content="ThemeForces.Com">
    
    <!-- Favicons
    ================================================== -->
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="img/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="img/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="img/apple-touch-icon-114x114.png">

    <!-- Bootstrap -->
    <link rel="stylesheet" type="text/css"  href="css/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="font-awesome-4.2.0/css/font-awesome.css">

    <link href="css/owl.carousel.css" rel="stylesheet" media="screen">
    <link href="css/owl.theme.css" rel="stylesheet" media="screen">

    <!-- Stylesheet
    ================================================== -->
    <link rel="stylesheet" type="text/css"  href="css/style.css">

    <script type="text/javascript" src="js/modernizr.custom.js"></script>
    <!--Google Font-->
    <link href='http://fonts.googleapis.com/css?family=Raleway:100,200,300,400,500,600,700,800,900' rel='stylesheet' type='text/css'>


  </head>
  <body>

    <div id="header" class="text-center">
        <img src="img/images.png" class="logo" alt="...">
        <h1>Umbraco JWT Token</h1>
    </div>
<h2><a id="What_are_JWTs_5"></a>Project's origin</h2>
<p>This project has originally been started by <a href="https://github.com/warrenbuckley">Warren Bucckley</a></p>
</p>The original project is discontinued by its author. You'd find here, latest version of the sources shipped by Nuget (1.1.0.0).</p>


<h2><a id="What_are_JWTs_5"></a>Repo roadmap</h2>
   <p>Don't expect much !</p>
   <p>The main point of this repo it for you to get a fresh copy of the sources. Once you got that far, maybe you would find several way to adapt the code to your own needs.</p>
   <p>I <i>may</i> plan at some point to include recent copy of integration with Angular.</p>
    
    <h2><a id="Release_Notes_132"></a>Release Notes</h2>
<ul>
<li>1.0.0.0 - Initial Release</li>
<li>1.1.0.0 - Update to DB schema and adds abbility to use JWT’s with members as well now</li>
</ul>

    <h1><a id="Umbraco_JWT_AuthTokens_0"></a>Umbraco JWT AuthTokens</h1>
<p>This is a repository for providing a secure based API to perform backoffice actions using JWT Auth tokens</p>
<h2><a id="What_are_JWTs_5"></a>What are JWTs?</h2>
<p>They are an auth token that allows you to send a piece of JSON encoded as a token and are the more modern approach to deal with auth in applications<br>
especially as we build applications across different devices. The videos below will do a lot better trying to explain it than I can do.</p>
<h2><a id="Why_do_this_9"></a>Why do this?</h2>
<p>I needed to create this POC for an upcoming pet project I am currently hacking &amp; building. I needed a way to authenticate to any Umbraco backoffice using<br>
the same credentials as the Umbraco backoffice user &amp; ensure they have access to specific section/s on that user. The user will only need to login once and we<br>
then store the auth token in local storage or cookies and use that token from storage or cookie for any future secured/protected API calls.</p>
<h2><a id="More_Resources_on_JWTs_14"></a>More Resources on JWTs</h2>
<p><strong>NG Europe talk from <a href="http://0Auth.com">0Auth.com</a> guys</strong>&lt;br/&gt;<br>
<a href="https://www.youtube.com/watch?v=lDb_GANDR8U&amp;list=UUEGUP3TJJfMsEM_1y8iviSQ">https://www.youtube.com/watch?v=lDb_GANDR8U&amp;list=UUEGUP3TJJfMsEM_1y8iviSQ</a></p>
<p><strong>Another good talk on JWT</strong>&lt;br/&gt;<br>
<a href="https://www.youtube.com/watch?v=vIGZxeQUUFU#t=83">https://www.youtube.com/watch?v=vIGZxeQUUFU#t=83</a></p>
<p><strong>Debugger tool</strong>&lt;br/&gt;<br>
<a href="http://jwt.io">http://jwt.io</a></p>
<p><strong>Single Class File Library &amp; Nuget Package I use for JWT dedcoding&lt;br/&gt;<br>
Authored by FireBase, Twilio &amp; others</strong>&lt;br/&gt;<br>
<a href="http://www.nuget.org/packages/JWT/">http://www.nuget.org/packages/JWT/</a>&lt;br/&gt;<br>
<a href="https://github.com/johnsheehan/jwt/blob/master/JWT/JWT.cs">https://github.com/johnsheehan/jwt/blob/master/JWT/JWT.cs</a></p>
<h2><a id="Explaining_how_my_implementation_works_29"></a>Explaining how my implementation works</h2>
<ol>
<li>
<p>A user will do a HTTP post of their backoffice Umbraco username &amp; password to a normal API Controller</p>
</li>
<li>
<p>Controller verifies credentials</p>
</li>
<li>
<p>If a token already exists for the user (matches against user id) in custom PetaPoco DB table</p>
</li>
<li>
<p>If no token exists create a new token for the user &amp; store in the DB table</p>
</li>
<li>
<p>Return existing or newly created token in the response</p>
</li>
<li>
<p>A user can then store that token say in LocalStorage or Cookie</p>
</li>
<li>
<p>User calls secured API sends bearer auth token in HTTP header for request (From LocalStorage or cookie)</p>
</li>
<li>
<p>Server finds token in request</p>
</li>
<li>
<p>Tries to decode the token with secret</p>
</li>
<li>
<p>If token not encoded with same secret Send 401</p>
</li>
<li>
<p>If token can be decoded correctly find user id in JSON</p>
</li>
<li>
<p>Check if user has the same token stored in the DB</p>
</li>
<li>
<p>If so process method on API controller</p>
</li>
<li>
<p>User changes password in Umbraco backoffice</p>
</li>
<li>
<p>If no token exists in DB - nothing happens</p>
</li>
<li>
<p>If token exists in DB - generate new token with new datetime stamp to make it unique from last time</p>
</li>
</ol>
<h2><a id="Why_do_you_not_just_store_the_username__password_in_the_JWT_50"></a>Why do you not just store the username &amp; password in the JWT?</h2>
<p>The payload of the JSON object in the JWT can be decoded easily, paste in a token into <a href="http://jwt.io">jwt.io</a> and you can see it easily.<br>
However the part to do with JWT is that we verify that the AuthToken is using the signed secret/string to ensure our server created the JWT &amp; it’s validity.</p>
<p>So in my implementation I only store the username, user ID, user role and Created Date of the token. The date ensures that the token is different every time<br>
a new one is generated for easy revoking.</p>
<h2><a id="Do_the_tokens_expire_57"></a>Do the tokens expire?</h2>
<p>My implementation allows the tokens to work indefinitely until the user in the Umbraco backoffice changes their password.<br>
Which creates a new token and thus revoking access to the API for any clients or services using it.</p>
<p>However it is easily possible to store an expiry date in the JSON payload of the Auth Token and when decoding it verifying the expiry date on it.</p>
<h1><a id="How_to_use_this_63"></a>How to use this</h1>
<p>Here are some simple instructions on how to use this to secure an API Controller in your Umbraco website with JWT Auth Tokens.</p>
<h2><a id="Creating_your_API_Controller_Class_67"></a>Creating your API Controller Class</h2>
<p>You will need to implement the following class <code>UmbracoAuthTokenApiController</code> similar to how you would use <code>UmbracoApiController</code> or <code>UmbracoAuthorizedApiController</code></p>
<p>See the Umbraco Documentation for Umbraco API Controller Reference:&lt;br/&gt;<br>
<a href="http://our.umbraco.org/documentation/Reference/WebApi/">http://our.umbraco.org/documentation/Reference/WebApi/</a>&lt;br/&gt;<br>
<a href="http://our.umbraco.org/documentation/Reference/WebApi/authorization">http://our.umbraco.org/documentation/Reference/WebApi/authorization</a></p>
<p>Implementing the <code>UmbracoAuthTokenApiController</code> in conjuction with the <code>UmbracoAuthToken</code> attribute to decorate the API class allows us to access a new property in the Web API controller called <code>AuthorisedBackofficeUser</code> which is the authorised Umbraco backoffice user from the JWT token, this can be used with the normal Umbraco Services APIs to Create Content and assign the correct user to the creation of that node.</p>
<h2><a id="Authorising_the_user__obtaining_a_JWT_token_76"></a>Authorising the user &amp; obtaining a JWT token</h2>
<p>In this project there is a built in Web API URL route for you to do a HTTP POST with the Username and Password. Your application to gain a JWT token must POST to this URL:<br>
<a href="http://yoursite.co.uk/umbraco/TokenAuth/SecureApi/Authorise">http://yoursite.co.uk/umbraco/TokenAuth/SecureApi/Authorise</a></p>
<h2><a id="Secured_API_Controller_80"></a>Secured API Controller</h2>
<p>The following is a very simple secued Umbraco API controller, obviously your needs and uses will be much better than the very basic example shown here.</p>
<p>The <code>UmbracoAuthToken</code> attribute has an optional parameter <code>HasAccessToSections</code> which is an string array of Umbraco backoffice section aliases that the attempted backoffice Umbraco user should have access to.</p>
<p>For example this checks the following user has access to the <code>content</code> and the <code>settings</code> sections, if they do not have access to <strong>both</strong> sections then the WebAPI will return 401 Unauthorised HTTP Error Code.</p>
<p><code>[UmbracoAuthToken(&quot;content&quot;, &quot;settings&quot;)]</code></p>
<h3><a id="Full_Example_89"></a>Full Example</h3>
<pre><code class="language-cs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Web.Http;
<span class="hljs-keyword">using</span> Umbraco.Core.Models;
<span class="hljs-keyword">using</span> Umbraco.Web.Mvc;
<span class="hljs-keyword">using</span> UmbracoAuthTokens.Attributes;
<span class="hljs-keyword">using</span> UmbracoAuthTokens.Controllers;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">UmbracoAuthTokens.TestApi</span>
{
    [PluginController(<span class="hljs-string">"Secured"</span>)]
    [UmbracoAuthToken(<span class="hljs-string">"content"</span>, <span class="hljs-string">"settings"</span>)]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ContentApiController</span> : <span class="hljs-title">UmbracoAuthTokenApiController</span>
    {
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> A simple GET that shows the backoffice user's name &amp; email address from the JWT Auth Token</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;returns&gt;</span><span class="hljs-xmlDocTag">&lt;/returns&gt;</span></span>
        [HttpGet]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> <span class="hljs-title">SecurePing</span>(<span class="hljs-params"></span>)
        </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">string</span>.Format(<span class="hljs-string">"Secure Pong from {0} {1}"</span>, AuthorisedBackofficeUser.Name, AuthorisedBackofficeUser.Email);
        }


        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> Note this is NOT a great example. As you would POST data to create a node.</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> As opposed to a GET with this hardcoded values</span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-xmlDocTag">///</span> <span class="hljs-xmlDocTag">&lt;returns&gt;</span><span class="hljs-xmlDocTag">&lt;/returns&gt;</span></span>
        [HttpGet]
        <span class="hljs-function"><span class="hljs-keyword">public</span> IContent <span class="hljs-title">CreateNewRootNode</span>(<span class="hljs-params"></span>)
        </span>{
            <span class="hljs-keyword">var</span> newNodeName = <span class="hljs-keyword">string</span>.Format(<span class="hljs-string">"New Node {0}"</span>, DateTime.Now.ToShortDateString());
            <span class="hljs-keyword">var</span> parentNodeId = -<span class="hljs-number">1</span>;
            <span class="hljs-keyword">var</span> contentTypeAlias = <span class="hljs-string">"Home"</span>;

            <span class="hljs-keyword">return</span> Services.ContentService.CreateContentWithIdentity(newNodeName, parentNodeId, contentTypeAlias, AuthorisedBackofficeUser.Id);
        }
    }
}
</code></pre>


  </body>
</html>
